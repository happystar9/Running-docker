@page "/Profile"
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@inject IPlayerService PlayerService
@inject AuthenticationStateProvider AuthStateProvider


@using Microsoft.AspNetCore.Components.Forms
@using TetrisWeb.ApiServices

@attribute [Authorize]

<PageTitle>Player Profile</PageTitle>

<AuthorizeView>
	@if (player is null)
	{
		<div class="profile-container">
			<p>Player not found. Please register to play.</p>

			<EditForm Model="newPlayer" OnValidSubmit="RegisterPlayer" Context="editContext">
				<InputText @bind-Value="newPlayer.Username" placeholder="Username" class="input" />
				<InputText @bind-Value="newPlayer.PlayerQuote" placeholder="Favorite Quote" class="input" />
				<InputFile OnChange="HandlePhotoSelected" accept="image/*" />
				@if (!string.IsNullOrEmpty(_photoUrl))
				{
					<img src="@_photoUrl" alt="Selected Avatar" class="vehicle-note-photo" />
				}
				<button type="submit">Register</button>
			</EditForm>
		</div>
	}
	else
	{
		<div class="profile-container">
			<h2>@player.Username</h2>
			<p>Quote: @player.PlayerQuote</p>
			<img style="width:40px" src="@player.AvatarUrl" alt="player avatar" />
			<p>Total Score: @totalScore</p>
		</div>
	}
</AuthorizeView>




@code {
	[Parameter] public string name { get; set; }
	private string authid = null;
	private bool isAuthenticated = false;
	PlayerDto newPlayer = new PlayerDto();
	PlayerDto player = null;
	int totalScore = 0;
	AuthenticationState authState = null;
	private string _photoUrl;


	protected override async Task OnInitializedAsync()
	{

		authState = await AuthStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;

		if (user.Identity == null)
		{
			Navigation.NavigateTo("/login", true);
		}
		else
		{
			isAuthenticated = true;

			if (user.Identity?.IsAuthenticated == true)
			{
				var applicationUser = await UserManager.GetUserAsync(user);
				if (applicationUser != null)
				{
					authid = applicationUser.Id;
				}
			}

			try
			{
				player = await PlayerService.GetPlayerByAuthIdAsync(authid);
				totalScore = await PlayerService.GetPlayerTotalScore(authid);
			}
			catch (KeyNotFoundException)
			{
				player = null;
			}
		}
	}

	public async Task RegisterPlayer()
	{
		//await CreatePlayerAsync()
		newPlayer.Authid = authid;
		await PlayerService.CreatePlayerAsync(newPlayer);
		player = await PlayerService.GetPlayerByAuthIdAsync(authid);
		totalScore = await PlayerService.GetPlayerTotalScore(authid);
		// StateHasChanged();
	}

	//in the register page, do we want to call the CreateUser service method, or the register POST endpoint ?

	private async Task HandlePhotoSelected(InputFileChangeEventArgs files)
	{
		var sourceFile = files.File;
		if (sourceFile != null)
		{
			using var stream = new MemoryStream();
			await sourceFile.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(stream);

			_photoUrl = $"data:{sourceFile.ContentType};base64,{Convert.ToBase64String(stream.ToArray())}";

			newPlayer.AvatarUrl = _photoUrl;
		}
	}
}

